# Anime Hot

**[English](README.en.md)** | **[æ—¥æœ¬èª](README.ja.md)** | **[ä¸­æ–‡](README.md)**

[![Go Version](https://img.shields.io/badge/Go-1.24+-00ADD8?style=flat&logo=go)](https://go.dev/)
[![Python Version](https://img.shields.io/badge/Python-3.11+-3776AB?style=flat&logo=python)](https://python.org/)
[![K3s](https://img.shields.io/badge/K3s-Lightweight%20K8s-FFC61C?style=flat&logo=k3s)](https://k3s.io/)
[![Redis](https://img.shields.io/badge/Redis-7.x-DC382D?style=flat&logo=redis)](https://redis.io/)
[![Grafana](https://img.shields.io/badge/Grafana-Cloud-F46800?style=flat&logo=grafana)](https://grafana.com/)
[![CI](https://github.com/KahanaT800/animehot/actions/workflows/ci.yml/badge.svg)](https://github.com/KahanaT800/animehot/actions/workflows/ci.yml)
[![Deploy](https://github.com/KahanaT800/animehot/actions/workflows/deploy.yml/badge.svg)](https://github.com/KahanaT800/animehot/actions/workflows/deploy.yml)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Website](https://img.shields.io/website?url=https%3A%2F%2Fanime-hot.com&label=anime-hot.com)](https://anime-hot.com)

### [ğŸ”¥ ä»Šã™ãäººæ°—ã‚¢ãƒ‹ãƒ¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ â†’](https://anime-hot.com)

æ—¥æœ¬ã®ä¸­å¤å¸‚å ´ã«ãŠã‘ã‚‹ã‚¢ãƒ‹ãƒ¡IPæµå‹•æ€§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã€‚

## æ¦‚è¦

Anime Hotã¯ã€[ãƒ¡ãƒ«ã‚«ãƒª](https://jp.mercari.com/)ï¼ˆæ—¥æœ¬æœ€å¤§ã®ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªï¼‰ã«ãŠã‘ã‚‹ã‚¢ãƒ‹ãƒ¡ã‚°ãƒƒã‚ºã®æµé€šã‚’åˆ†æã—ã€ã‚¢ãƒ‹ãƒ¡IPã®ã€Œæµå‹•æ€§æŒ‡æ•°ã€ã‚’ç®—å‡ºã—ã¾ã™ã€‚æ¯æ™‚ã®æµå…¥ï¼ˆæ–°è¦å‡ºå“ï¼‰ã¨æµå‡ºï¼ˆå£²å´æ¸ˆã¿ï¼‰ã‚’è¿½è·¡ã™ã‚‹ã“ã¨ã§ã€ãƒˆãƒ¬ãƒ³ãƒ‰IPã®ç‰¹å®šã‚„ãƒ•ã‚¡ãƒ³é›¢ã‚Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºãŒå¯èƒ½ã§ã™ã€‚

### ä¸»è¦æŒ‡æ¨™

| æŒ‡æ¨™ | è¨ˆç®—å¼ | æ„å‘³ |
|------|--------|------|
| **æµå…¥** | æ¯æ™‚ã®æ–°è¦å‡ºå“æ•° | å¸‚å ´ã¸ã®ä¾›çµ¦ |
| **æµå‡º** | æ¯æ™‚ã®å£²å´æ•° | éœ€è¦ / å®Ÿéš›ã®è²©å£² |
| **æµå‹•æ€§æŒ‡æ•°** | æµå‡º / æµå…¥ | å¸‚å ´ã®å›è»¢é€Ÿåº¦ |
| **ãƒ›ãƒƒãƒˆã‚¹ã‚³ã‚¢** | (Out+1)/(In+1) Ã— log(Out+1) | åŠ é‡äººæ°—ã‚¹ã‚³ã‚¢ |

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

- **ãƒˆãƒ¬ãƒ³ãƒ‰æ¤œå‡º**: äººæ°—ä¸Šæ˜‡ä¸­ã¾ãŸã¯ä¸‹é™ä¸­ã®IPã‚’ç‰¹å®š
- **å¸‚å ´åˆ†æ**: ç•°ãªã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºé–“ã®éœ€çµ¦æ¯”è¼ƒ
- **æŠ•è³‡ã‚·ã‚°ãƒŠãƒ«**: éå°è©•ä¾¡ã¾ãŸã¯éç†±ã—ã¦ã„ã‚‹ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚ºã‚¢ã‚¤ãƒ†ãƒ ã®ç™ºè¦‹

## ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ

<p align="center">
  <img src="docs/screenshots/dashboard.png" alt="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" width="800">
  <br>
  <em>äººæ°—ã‚¢ãƒ‹ãƒ¡IPã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</em>
</p>

<p align="center">
  <img src="docs/screenshots/ip-detail.png" alt="IPè©³ç´°" width="800">
  <br>
  <em>å€‹åˆ¥IPã®è©³ç´°ãªæµå‹•æ€§åˆ†æ</em>
</p>

<p align="center">
  <img src="docs/screenshots/grafana.png" alt="Grafanaãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°" width="800">
  <br>
  <em>Grafana Cloudãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</em>
</p>

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

```mermaid
graph TB
    CLIENT[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]

    subgraph EC2[AWS EC2 - ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ / K3s Server]
        NGINX[Nginx :80/:443]
        ANALYZER[Analyzer :8080]
        MYSQL[(MySQL)]
        REDIS[(Redis)]
        KEDA[KEDA]
        SCALER[Spot ASG Scaler]
    end

    subgraph SPOT[AWS Spot ãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ« - K3s Agent]
        CRAWLER1[py-crawler Pod]
        CRAWLER2[py-crawler Pod]
        ALLOY[Alloy DaemonSet]
    end

    MERCARI[ãƒ¡ãƒ«ã‚«ãƒª]
    GRAFANA[Grafana Cloud]
    ASG[EC2 Auto Scaling Group]

    CLIENT --> NGINX
    NGINX --> ANALYZER
    ANALYZER <--> MYSQL
    ANALYZER <--> REDIS

    KEDA -->|ã‚­ãƒ¥ãƒ¼æ·±åº¦| SCALER
    SCALER -->|å®¹é‡èª¿æ•´| ASG
    ASG -->|èµ·å‹•/çµ‚äº†| SPOT

    CRAWLER1 & CRAWLER2 -.->|Tailscale VPN| REDIS
    CRAWLER1 & CRAWLER2 --> MERCARI

    ALLOY --> GRAFANA
```

### ã‚³ã‚¢è¨­è¨ˆ

- **K3sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼**: EC2ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ãŒServerã€Spotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒAgentãƒãƒ¼ãƒ‰
- **KEDAã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: Redisã‚­ãƒ¥ãƒ¼æ·±åº¦ã«åŸºã¥ã„ã¦py-crawlerãƒ¬ãƒ—ãƒªã‚«ã‚’è‡ªå‹•èª¿æ•´
- **Spot ASG Scaler**: Pod pendingçŠ¶æ…‹ã«å¿œã˜ã¦Spotãƒãƒ¼ãƒ‰ã‚’èµ·å‹•ã€ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã«è‡ªå‹•çµ‚äº†
- **Tailscale VPN**: Spotãƒãƒ¼ãƒ‰ãŒTailscaleçµŒç”±ã§ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã®Redisã«æ¥ç¶š
- **Grafana Alloy**: DaemonSetã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã€å…¨ãƒãƒ¼ãƒ‰ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ­ã‚°ã‚’è‡ªå‹•åé›†

### ã‚¿ã‚¹ã‚¯ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant ZSET as Redis ZSET
    participant SCH as ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼
    participant RQ as Redis Queue
    participant CRW as Crawler (ä»»æ„)
    participant SM as ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³
    participant PIP as ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
    participant DB as MySQL

    SCH->>ZSET: æ¬¡å›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»ã‚’å–å¾—
    SCH->>SCH: ãã®æ™‚åˆ»ã¾ã§ç²¾ç¢ºã«ã‚¹ãƒªãƒ¼ãƒ—
    SCH->>ZSET: æœŸé™åˆ‡ã‚ŒIPã‚’å–å¾—
    SCH->>RQ: ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ã‚’ãƒ—ãƒƒã‚·ãƒ¥

    loop ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ«ãƒ¼ãƒ—
        CRW->>RQ: ã‚¿ã‚¹ã‚¯ã‚’å–å¾— (BRPOP)
        CRW->>CRW: HTTPèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        CRW->>CRW: on_sale 5ãƒšãƒ¼ã‚¸ã‚’ã‚¯ãƒ­ãƒ¼ãƒ«
        CRW->>CRW: sold 5ãƒšãƒ¼ã‚¸ã‚’ã‚¯ãƒ­ãƒ¼ãƒ«
        CRW->>RQ: çµæœã‚’ãƒ—ãƒƒã‚·ãƒ¥
    end

    PIP->>RQ: çµæœã‚’å–å¾—
    PIP->>SM: ã‚¢ã‚¤ãƒ†ãƒ ãƒãƒƒãƒã‚’å‡¦ç†
    SM->>SM: é·ç§»ã‚’æ¤œå‡º (new_listing, sold, price_change)
    SM-->>PIP: é·ç§»ã‚’è¿”å´
    PIP->>PIP: æŒ‡æ¨™ã‚’è¨ˆç®— (inflow, outflow, liquidity)
    PIP->>DB: æ¯æ™‚çµ±è¨ˆã‚’æ›¸ãè¾¼ã¿
    PIP->>ZSET: æ¬¡å›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–° (ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ãƒ«ãƒ¼ãƒ—)
    PIP->>RQ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Go 1.24+ (Gin + GORM)
- **ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼**: Python 3.11+ (HTTPèªè¨¼ + Playwrightãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: Protocol Buffers (protojson)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: MySQL 8.0 + Redis 7.x
- **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**: Prometheus + Grafana Cloud + Alloy

## ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å‰ææ¡ä»¶

- Docker & Docker Compose
- Go 1.24+ (ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨)

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/KahanaT800/animehot
cd animehot

# ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
cp .env.example .env

# ã‚¤ãƒ³ãƒ•ãƒ©ã‚’èµ·å‹• (MySQL + Redis)
make dev-deps

# Analyzerã‚’å®Ÿè¡Œ (ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1)
make dev-analyzer

# Crawlerã‚’å®Ÿè¡Œ (ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2)
make dev-crawler

# ãƒ†ã‚¹ãƒˆIPã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
make api-import-run FILE=data/ips.json
```

### Dockerãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ (MySQL + Redis + Analyzer + Crawler)
make docker-up

# ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ (ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãªã—ã€ãƒ†ã‚¹ãƒˆç”¨)
make docker-light-up

# ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ä»˜ã (Grafana Cloud)
make docker-up-monitoring

# ãƒ­ã‚°ã‚’ç¢ºèª
make docker-logs
```

## æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

### EC2ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. Dockerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo yum update -y
sudo yum install -y docker git
sudo systemctl start docker && sudo systemctl enable docker
sudo usermod -aG docker ec2-user

# 2. Docker Composeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
  -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 3. Tailscaleã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (åˆ†æ•£ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨)
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up

# 4. ã‚¯ãƒ­ãƒ¼ãƒ³ã¨è¨­å®š
git clone https://github.com/lyc0603/animetop.git
cd animetop
cp .env.example .env
# .envã‚’æœ¬ç•ªç”¨ã®å€¤ã«ç·¨é›†

# 5. SSLåˆæœŸåŒ–ã¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
export DOMAIN_NAME=your-domain.com
export LETSENCRYPT_EMAIL=admin@your-domain.com
./deploy/certbot/init-letsencrypt.sh
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] MySQLãƒãƒ¼ãƒˆ (3306) ãŒå¤–éƒ¨ã«å…¬é–‹ã•ã‚Œã¦ã„ãªã„
- [ ] Redisã¯Tailscale VPNçµŒç”±ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] Admin APIã¯`ADMIN_API_KEY`ã§ä¿è­·
- [ ] HTTPSãŒHSTSã§å¼·åˆ¶
- [ ] `/metrics`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¤–éƒ¨ã‹ã‚‰ãƒ–ãƒ­ãƒƒã‚¯

## K8s/Spot åˆ†æ•£ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼

AWS Spotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã§ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®¹é‡ã‚’æ‹¡å¼µã€‚ã‚³ã‚¹ãƒˆã¯ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®10-30%ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
EC2ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ (K3s Server)          Spotãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ« (K3s Agent)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Analyzer           â”‚          â”‚  py-crawler Pod     â”‚
â”‚  MySQL / Redis      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  py-crawler Pod     â”‚
â”‚  KEDA               â”‚ Tailscaleâ”‚  Alloy DaemonSet    â”‚
â”‚  Spot ASG Scaler    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â–²
         â”‚                                 â”‚
         â–¼                                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å®¹é‡èª¿æ•´      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ã‚­ãƒ¥ãƒ¼æ·±åº¦ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  EC2 ASG      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯

| ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|-------------|-----------|
| ã‚­ãƒ¥ãƒ¼æ·±åº¦ > 0 | KEDAãŒpy-crawler Podã‚’ä½œæˆ |
| Pod pending (ãƒãƒ¼ãƒ‰ãªã—) | ScalerãŒSpotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹• |
| ãƒãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ‰ãƒ«15åˆ† | ScalerãŒSpotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’çµ‚äº† |
| Spotä¸­æ–­é€šçŸ¥ | Podã‚’å„ªé›…ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã€ãƒãƒ¼ãƒ‰è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— |

### K3sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åˆæœŸåŒ–

```bash
# EC2ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ - K3s Serverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl -sfL https://get.k3s.io | sh -s - server \
  --tls-san $(tailscale ip -4) \
  --node-external-ip $(tailscale ip -4)

# join tokenã‚’å–å¾—
cat /var/lib/rancher/k3s/server/node-token

# K8sãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/secrets.yaml  # å…ˆã«èªè¨¼æƒ…å ±ã‚’è¨˜å…¥
kubectl apply -f k8s/py-crawler.yaml
kubectl apply -f k8s/keda-scaledobject.yaml
kubectl apply -f k8s/spot-asg-scaler.yaml
kubectl apply -f k8s/alloy-configmap.yaml
kubectl apply -f k8s/alloy-daemonset.yaml
```

### ä¸»è¦K8sãƒªã‚½ãƒ¼ã‚¹

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `k8s/py-crawler.yaml` | py-crawler Deployment |
| `k8s/keda-scaledobject.yaml` | KEDAã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ« |
| `k8s/spot-asg-scaler.yaml` | Spotãƒãƒ¼ãƒ‰ç®¡ç†CronJob |
| `k8s/alloy-*.yaml` | Grafana Alloyãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š |
| `k8s/secrets.yaml.template` | èªè¨¼æƒ…å ±ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ |

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### Grafana Cloudã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. [Grafana Cloud](https://grafana.com/products/cloud/)ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
2. Prometheusãƒªãƒ¢ãƒ¼ãƒˆãƒ©ã‚¤ãƒˆèªè¨¼æƒ…å ±ã‚’å–å¾—
3. Lokièªè¨¼æƒ…å ±ã‚’å–å¾— (ãƒ­ã‚°ç”¨)
4. `.env`ã«è¨­å®š:

```bash
GRAFANA_CLOUD_PROM_REMOTE_WRITE_URL=https://prometheus-xxx.grafana.net/api/prom/push
GRAFANA_CLOUD_PROM_USERNAME=your_username
GRAFANA_CLOUD_PROM_API_KEY=glc_xxx

GRAFANA_CLOUD_LOKI_URL=https://logs-xxx.grafana.net/loki/api/v1/push
GRAFANA_CLOUD_LOKI_USERNAME=your_username
GRAFANA_CLOUD_LOKI_API_KEY=glc_xxx
```

5. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§èµ·å‹•:

```bash
docker compose -f docker-compose.prod.yml --profile monitoring up -d
```

### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

`deploy/grafana/dashboards/animehot-business.json`ã‹ã‚‰ãƒ“ã‚¸ãƒã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ:

| ã‚»ã‚¯ã‚·ãƒ§ãƒ³ | ãƒ‘ãƒãƒ« |
|-----------|--------|
| Overview | ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯ã€ã‚­ãƒ¥ãƒ¼æ·±åº¦ |
| Spot Py-Crawler | ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼æ•°ã€ã‚¿ã‚¹ã‚¯é€²æ—ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€Authãƒ¢ãƒ¼ãƒ‰ |
| Task Queue | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€ã‚­ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| Redis Queues | DLQã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«IPã€ã‚¿ã‚¹ã‚¯/çµæœã‚­ãƒ¥ãƒ¼ |

### ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | èª¬æ˜ |
|-----------|------|
| `up{job="animetop-analyzer"}` | Analyzeræ­£å¸¸æ€§ |
| `up{app="py-crawler", cluster="animehot-k3s"}` | Spotã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼æ­£å¸¸æ€§ |
| `mercari_crawler_tasks_in_progress{cluster="animehot-k3s"}` | Spotå‡¦ç†ä¸­ã‚¿ã‚¹ã‚¯æ•° |
| `mercari_crawler_api_request_duration_seconds` | APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚· |
| `mercari_crawler_auth_mode` | èªè¨¼ãƒ¢ãƒ¼ãƒ‰ (0=HTTP, 1=Browser) |
| `animetop_scheduler_tasks_pending_in_queue` | ã‚­ãƒ¥ãƒ¼æ·±åº¦ |

## APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èª¬æ˜ |
|---------|------|------|
| GET | `/health` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |
| GET | `/api/v1/ips` | è¿½è·¡ä¸­ã®å…¨IPãƒªã‚¹ãƒˆ |
| GET | `/api/v1/ips/:id` | IPè©³ç´° |
| GET | `/api/v1/ips/:id/liquidity` | æµå‹•æ€§ãƒ‡ãƒ¼ã‚¿ |
| GET | `/api/v1/ips/:id/stats/hourly` | æ¯æ™‚çµ±è¨ˆ |
| GET | `/api/v1/ips/:id/items` | ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ |
| GET | `/api/v1/leaderboard` | ãƒ©ãƒ³ã‚­ãƒ³ã‚° |
| GET | `/api/v1/system/status` | ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| POST | `/api/v1/admin/import` | IPã‚¤ãƒ³ãƒãƒ¼ãƒˆ (APIã‚­ãƒ¼å¿…è¦) |

### ãƒ©ãƒ³ã‚­ãƒ³ã‚°API

```bash
# éå»24æ™‚é–“ã®ãƒ›ãƒƒãƒˆIPä¸Šä½10ä»¶ã‚’å–å¾—
curl "http://localhost:8080/api/v1/leaderboard?type=hot&hours=24&limit=10"
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
- `type`: `hot` | `inflow` | `outflow`
- `hours`: 1-168 (æ™‚é–“çª“)
- `limit`: 1-100

ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
```json
{
  "code": 0,
  "data": {
    "type": "hot",
    "hours": 24,
    "time_range": {
      "start": "2026-01-17T17:00:00+09:00",
      "end": "2026-01-18T17:00:00+09:00"
    },
    "items": [
      {
        "rank": 1,
        "ip_id": 11,
        "ip_name": "é¬¼æ»…ã®åˆƒ",
        "inflow": 355,
        "outflow": 28,
        "score": 0.2634
      }
    ]
  }
}
```

### Admin API

```bash
# IPã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (æœ¬ç•ªç’°å¢ƒã§ã¯X-API-Keyãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…è¦)
curl -X POST http://localhost:8080/api/v1/admin/import \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your_api_key" \
  -d @data/ips.json
```

## è¨­å®š

### ä¸»è¦ç’°å¢ƒå¤‰æ•°

```bash
# ãƒ‰ãƒ¡ã‚¤ãƒ³ (SSLç”¨)
DOMAIN_NAME=anime-hot.com
LETSENCRYPT_EMAIL=admin@anime-hot.com

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
ADMIN_API_KEY=your_secure_api_key

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
MYSQL_PASSWORD=your_secure_password

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ (ZSETæ°¸ç¶šåŒ– + ç²¾ç¢ºã‚¹ãƒªãƒ¼ãƒ—)
SCHEDULER_BASE_INTERVAL=2h      # åŸºæœ¬ã‚¯ãƒ­ãƒ¼ãƒ«é–“éš”
SCHEDULER_MIN_INTERVAL=1h       # æœ€å°é–“éš” (ãƒ›ãƒƒãƒˆIP)
SCHEDULER_MAX_INTERVAL=2h       # æœ€å¤§é–“éš”

# ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼
BROWSER_MAX_CONCURRENCY=2       # åŒæ™‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–æ•°
SCHEDULER_PAGES_ON_SALE=5       # ã‚¯ãƒ­ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸æ•° (è²©å£²ä¸­)
SCHEDULER_PAGES_SOLD=5          # ã‚¯ãƒ­ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸æ•° (å£²å´æ¸ˆã¿)
```

### å‹•çš„é–“éš”èª¿æ•´

ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã«åŸºã¥ã„ã¦ã‚¯ãƒ­ãƒ¼ãƒ«é »åº¦ã‚’è‡ªå‹•èª¿æ•´ (Redis ZSETã«ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ãƒ«ãƒ¼ãƒ—æ›´æ–°):

| æ¡ä»¶ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|------|-----------|
| inflow > 100Ã—pages ã¾ãŸã¯ outflow > 100Ã—pages | åŠ é€Ÿ (-15åˆ†) |
| inflow < 50Ã—pages ã‹ã¤ outflow < 3Ã—pages | æ¸›é€Ÿ (+15åˆ†) |
| ãã®ä»– | 2æ™‚é–“ã«å›å¸° |

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5+5ãƒšãƒ¼ã‚¸ã®å ´åˆ:
- **åŠ é€Ÿ**: inflow > 500 ã¾ãŸã¯ outflow > 500
- **æ¸›é€Ÿ**: inflow < 250 ã‹ã¤ outflow < 15

## Makeã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ“ãƒ«ãƒ‰
make build              # å…¨Goãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰
make test               # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
make lint               # ãƒªãƒ³ã‚¿ãƒ¼å®Ÿè¡Œ

# Docker - ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯
make docker-up          # å…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
make docker-down        # å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
make docker-logs        # ãƒ­ã‚°ç¢ºèª

# Docker - ãƒ©ã‚¤ãƒˆ (ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãªã—)
make docker-light-up    # MySQL + Redis + Analyzerèµ·å‹•
make docker-light-down  # ãƒ©ã‚¤ãƒˆã‚µãƒ¼ãƒ“ã‚¹åœæ­¢

# Docker - ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ä»˜ã
make docker-up-monitoring    # å…¨ã¦ + Grafana Alloyèµ·å‹•
make docker-down-monitoring  # å…¨ã¦ + ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°åœæ­¢

# é–‹ç™º
make dev-deps           # MySQL & Redisã®ã¿èµ·å‹•
make dev-analyzer       # Analyzerã‚’ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
make dev-crawler        # Crawlerã‚’ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ

# ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
make api-import-run FILE=data/ips.json

# ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
make grayscale-start    # ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ + ãƒ†ã‚¹ãƒˆIP
make grayscale-verify   # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ¤œè¨¼
make grayscale-clean    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
animetop/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ analyzer/          # API + Scheduler + Pipeline
â”‚   â”œâ”€â”€ crawler/           # ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¯ãƒ¼ã‚«ãƒ¼
â”‚   â””â”€â”€ import/            # IPãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ analyzer/          # ã‚³ã‚¢åˆ†æãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ pipeline.go    # çµæœå‡¦ç†
â”‚   â”‚   â”œâ”€â”€ state_machine.go  # ã‚¢ã‚¤ãƒ†ãƒ çŠ¶æ…‹è¿½è·¡
â”‚   â”‚   â””â”€â”€ cache.go       # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
â”‚   â”œâ”€â”€ api/               # HTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â”œâ”€â”€ config/            # è¨­å®š
â”‚   â”œâ”€â”€ crawler/           # ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ– (go-rod)
â”‚   â”œâ”€â”€ model/             # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ« (GORM)
â”‚   â”œâ”€â”€ pkg/               # å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ metrics/       # Prometheusãƒ¡ãƒˆãƒªã‚¯ã‚¹
â”‚   â”‚   â”œâ”€â”€ ratelimit/     # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â”‚   â”‚   â””â”€â”€ redisqueue/    # ä¿¡é ¼æ€§ã‚­ãƒ¥ãƒ¼
â”‚   â””â”€â”€ scheduler/         # IPã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
â”œâ”€â”€ k8s/                   # Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ py-crawler.yaml    # py-crawler Deployment
â”‚   â”œâ”€â”€ keda-scaledobject.yaml  # KEDAã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
â”‚   â”œâ”€â”€ spot-asg-scaler.yaml    # Spotãƒãƒ¼ãƒ‰ç®¡ç†
â”‚   â””â”€â”€ alloy-*.yaml       # Grafana Alloy DaemonSet
â”œâ”€â”€ infra/aws/             # AWSã‚¤ãƒ³ãƒ•ãƒ©
â”‚   â””â”€â”€ user-data-spot.sh  # Spotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ nginx/             # Nginxè¨­å®š
â”‚   â”œâ”€â”€ certbot/           # SSLåˆæœŸåŒ–
â”‚   â”œâ”€â”€ alloy/             # Grafana Alloyè¨­å®š
â”‚   â””â”€â”€ grafana/           # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰JSON
â”œâ”€â”€ proto/                 # Protocol Buffers
â”œâ”€â”€ migrations/            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ data/                  # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ (IP JSON)
â”œâ”€â”€ docker-compose.yml           # é–‹ç™ºç”¨
â”œâ”€â”€ docker-compose.prod.yml      # æœ¬ç•ª (EC2)
â””â”€â”€ docker-compose.crawler.yml   # ãƒ­ãƒ¼ã‚«ãƒ«ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãƒãƒ¼ãƒ‰
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### ip_metadata
IPï¼ˆçŸ¥çš„è²¡ç”£ï¼‰æƒ…å ±ã‚’æ ¼ç´ã€‚

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|------|------|
| id | INT | ä¸»ã‚­ãƒ¼ |
| name | VARCHAR | æ—¥æœ¬èªå |
| name_en | VARCHAR | è‹±èªå |
| category | VARCHAR | ã‚«ãƒ†ã‚´ãƒª (anime, gameç­‰) |
| weight | FLOAT | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å„ªå…ˆåº¦ |

### ip_stats_hourly
IPæ¯ã®æ¯æ™‚çµ±è¨ˆã€‚

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|------|------|
| ip_id | INT | ip_metadataã¸ã®å¤–éƒ¨ã‚­ãƒ¼ |
| hour_bucket | DATETIME | æ™‚é–“ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| inflow | INT | æ–°è¦å‡ºå“æ•° |
| outflow | INT | å£²å´æ•° |
| liquidity_index | FLOAT | outflow / inflow |

### item_snapshots
å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ è¿½è·¡ã€‚

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|------|------|
| source_id | VARCHAR | ãƒ¡ãƒ«ã‚«ãƒªã‚¢ã‚¤ãƒ†ãƒ ID |
| ip_id | INT | é–¢é€£IP |
| status | ENUM | on_sale, sold |
| price | INT | ä¾¡æ ¼ (å††) |
| first_seen | DATETIME | åˆå›ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚åˆ» |
| last_seen | DATETIME | æœ€çµ‚ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚åˆ» |

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãŒã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã—ãªã„

```bash
# ã‚­ãƒ¥ãƒ¼æ·±åº¦ã‚’ç¢ºèª
redis-cli LLEN animetop:queue:tasks

# py-crawler Podã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª (K8s)
kubectl get pods -n animehot -l app=py-crawler

# py-crawlerãƒ­ã‚°ã‚’ç¢ºèª (K8s)
kubectl logs -n animehot -l app=py-crawler --tail=100

# Spotãƒãƒ¼ãƒ‰ã‚’ç¢ºèª
kubectl get nodes -l node-role=spot
```

### Grafanaã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œãªã„

```bash
# Alloy DaemonSetã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
kubectl get ds -n animehot alloy

# Alloyãƒ­ã‚°ã‚’ç¢ºèª
kubectl logs -n animehot -l app=alloy --tail=50

# upãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèª
# Grafana: up{app="py-crawler", cluster="animehot-k3s"}
```

### Spotãƒãƒ¼ãƒ‰ãŒèµ·å‹•ã—ãªã„

```bash
# KEDA ScaledObjectã‚’ç¢ºèª
kubectl get scaledobject -n animehot

# spot-asg-scalerãƒ­ã‚°ã‚’ç¢ºèª
kubectl logs -n animehot -l app=spot-asg-scaler --tail=50

# EC2 ASGã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names animehot-spot
```

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT

## è¬è¾

- [ãƒ¡ãƒ«ã‚«ãƒª](https://jp.mercari.com/) - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- [go-rod](https://github.com/go-rod/rod) - ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–
- [Gin](https://github.com/gin-gonic/gin) - Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- [Grafana](https://grafana.com/) - ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
- [Tailscale](https://tailscale.com/) - åˆ†æ•£ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨VPN
- [K3s](https://k3s.io/) - è»½é‡Kubernetes
- [KEDA](https://keda.sh/) - Kubernetesã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
