# Anime Hot

**[English](README.en.md)** | **[æ—¥æœ¬èª](README.ja.md)** | **[ä¸­æ–‡](README.md)**

[![Go Version](https://img.shields.io/badge/Go-1.24+-00ADD8?style=flat&logo=go)](https://go.dev/)
[![Python Version](https://img.shields.io/badge/Python-3.11+-3776AB?style=flat&logo=python)](https://python.org/)
[![K3s](https://img.shields.io/badge/K3s-Lightweight%20K8s-FFC61C?style=flat&logo=k3s)](https://k3s.io/)
[![Redis](https://img.shields.io/badge/Redis-7.x-DC382D?style=flat&logo=redis)](https://redis.io/)
[![Grafana](https://img.shields.io/badge/Grafana-Cloud-F46800?style=flat&logo=grafana)](https://grafana.com/)
[![CI](https://github.com/KahanaT800/animehot/actions/workflows/ci.yml/badge.svg)](https://github.com/KahanaT800/animehot/actions/workflows/ci.yml)
[![Deploy](https://github.com/KahanaT800/animehot/actions/workflows/deploy.yml/badge.svg)](https://github.com/KahanaT800/animehot/actions/workflows/deploy.yml)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Website](https://img.shields.io/website?url=https%3A%2F%2Fanime-hot.com&label=anime-hot.com)](https://anime-hot.com)

ä½ çš„äºŒæ¬¡å…ƒå©†ç½—é—¨è®ºæˆ˜åˆ©å™¨ï¼šå®æ—¶è¿½è¸ªæ—¥æœ¬äºŒæ‰‹å¸‚åœºä¸Šå„å¤§åŠ¨æ¼«IPçš„æµåŠ¨æ€§æŒ‡æ•°ï¼Œçœ‹çœ‹è°åœ¨å…¥å‘ã€è°åœ¨é€€å‘ï¼

## è¿™æ˜¯ä»€ä¹ˆï¼Ÿ

ä½œä¸ºä¸€ä¸ªäºŒæ¬¡å…ƒå©†ç½—é—¨ï¼Œä½ æ˜¯ä¸æ˜¯ä¹Ÿæƒ³çŸ¥é“ï¼š
- å“ªäº›ç•ªæ‰æ˜¯æ­£åœ¨çš„å›½æ°‘çº§IP
- å“ªäº›ç•ªçš„ç²‰ä¸å¼€å§‹é€€å‘äº†ï¼ŸäºŒæ‰‹å¸‚åœºè¢«å‘¨è¾¹æ·¹æ²¡...ï¼ˆä¼šèµ¢çš„ï¼ï¼‰
- å…¥æ‰‹æŸä¸ªIPçš„å‘¨è¾¹ï¼Œæ˜¯æŠ„åº•è‰¯æœºè¿˜æ˜¯é«˜ä½æ¥ç›˜ï¼Ÿ
- é¬¼é©¬å’’ä¸‡å®¶åˆ°åº•è°æ˜¯å¾·ä¸é…ä½ï¼ˆ

### [ğŸ”¥ ç«‹åˆ»çœ‹çœ‹å“ªäº›ç•ªæœ€ç« â†’](https://anime-hot.com)

**Anime Hot** é€šè¿‡åˆ†æ [ç…¤ç‚‰](https://jp.mercari.com/)ï¼ˆæ—¥æœ¬æœ€å¤§çš„äºŒæ‰‹äº¤æ˜“å¹³å°ï¼‰ä¸Šçš„åŠ¨æ¼«å‘¨è¾¹äº¤æ˜“æ•°æ®ï¼Œè®¡ç®—æ¯ä¸ªIPçš„"æµåŠ¨æ€§æŒ‡æ•°"ï¼Œå¸®ä½ æ´å¯Ÿå¸‚åœºè¶‹åŠ¿ï¼

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | è®¡ç®—å…¬å¼ | äººè¯è§£é‡Š |
|------|---------|---------|
| **æµå…¥é‡** | æ¯å°æ—¶æ–°ä¸Šæ¶æ•° | æœ‰å¤šå°‘äººåœ¨å‡ºå‘¨è¾¹ï¼ˆå¯èƒ½åœ¨é€€å‘ï¼‰ |
| **æµå‡ºé‡** | æ¯å°æ—¶æˆäº¤æ•° | æœ‰å¤šå°‘äººåœ¨æ”¶å‘¨è¾¹ |
| **æµåŠ¨æ€§æŒ‡æ•°** | æµå‡º / æµå…¥ | è¶Šå¤§è¶Šå¼ºï¼ |
| **çƒ­åº¦åˆ†** | (Out+1)/(In+1) Ã— log(Out+1) | ç»¼åˆçƒ­åº¦è¯„åˆ† |

### èƒ½å¹²å•¥ï¼Ÿ

- **è¿½ç•ªé£å‘æ ‡**: å“ªäº›ç•ªæ­£åœ¨å‡ºåœˆï¼Ÿå“ªäº›ç•ªå‡‰äº†ï¼Ÿ
- **éŸ­èœé¢„è­¦å™¨**: æŸIPå‘¨è¾¹ä»·æ ¼è™šé«˜ï¼Ÿè¿˜æ˜¯æ¡æ¼è‰¯æœºï¼Ÿ
- **é€€å‘è§‚å¯Ÿç«™**: å¤§é‡å‘¨è¾¹æ¶Œå…¥äºŒæ‰‹å¸‚åœºï¼Œç²‰ä¸ä»¬è¿™æ˜¯æ€ä¹ˆäº†...ï¼ˆæˆ‘æ‰“å®¿å‚©ï¼Ÿï¼ï¼‰

## æˆªå›¾é¢„è§ˆ

<p align="center">
  <img src="docs/screenshots/dashboard.png" alt="æ’è¡Œæ¦œ" width="800">
  <br>
  <em>å®æ—¶çƒ­ç•ªæ’è¡Œæ¦œï¼Œçœ‹çœ‹è°æ˜¯æœ¬å­£éœ¸æƒï¼</em>
</p>

<p align="center">
  <img src="docs/screenshots/ip-detail.png" alt="IPè¯¦æƒ…" width="800">
  <br>
  <em>å•ä¸ªIPçš„è¯¦ç»†æµåŠ¨æ€§åˆ†æ</em>
</p>

<p align="center">
  <img src="docs/screenshots/grafana.png" alt="Grafanaç›‘æ§" width="800">
  <br>
  <em>Grafana Cloud ç›‘æ§é¢æ¿ï¼ˆè¿ç»´ç‹‚å–œï¼‰</em>
</p>

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

```mermaid
graph TB
    CLIENT[æµè§ˆå™¨]

    subgraph EC2[AWS EC2 - ä¸»èŠ‚ç‚¹ / K3s Server]
        NGINX[Nginx :80/:443]
        ANALYZER[Analyzer :8080]
        MYSQL[(MySQL)]
        REDIS[(Redis)]
        KEDA[KEDA]
        SCALER[Spot ASG Scaler]
    end

    subgraph SPOT[AWS Spot èŠ‚ç‚¹æ±  - K3s Agent]
        CRAWLER1[py-crawler Pod]
        CRAWLER2[py-crawler Pod]
        ALLOY[Alloy DaemonSet]
    end

    MERCARI[ç…¤ç‚‰]
    GRAFANA[Grafana Cloud]
    ASG[EC2 Auto Scaling Group]

    CLIENT --> NGINX
    NGINX --> ANALYZER
    ANALYZER <--> MYSQL
    ANALYZER <--> REDIS

    KEDA -->|é˜Ÿåˆ—æ·±åº¦| SCALER
    SCALER -->|è°ƒæ•´å®¹é‡| ASG
    ASG -->|å¯åŠ¨/ç»ˆæ­¢| SPOT

    CRAWLER1 & CRAWLER2 -.->|Tailscale VPN| REDIS
    CRAWLER1 & CRAWLER2 --> MERCARI

    ALLOY --> GRAFANA
```

### æ ¸å¿ƒè®¾è®¡

- **K3s é›†ç¾¤**: EC2 ä¸»èŠ‚ç‚¹ä½œä¸º Serverï¼ŒSpot å®ä¾‹ä½œä¸º Agent èŠ‚ç‚¹
- **KEDA è‡ªåŠ¨æ‰©ç¼©å®¹**: æ ¹æ® Redis é˜Ÿåˆ—æ·±åº¦è‡ªåŠ¨è°ƒæ•´ py-crawler å‰¯æœ¬æ•°
- **Spot ASG Scaler**: æ ¹æ® Pod pending çŠ¶æ€å¯åŠ¨ Spot èŠ‚ç‚¹ï¼Œç©ºé—²æ—¶è‡ªåŠ¨ç»ˆæ­¢
- **Tailscale VPN**: Spot èŠ‚ç‚¹é€šè¿‡ Tailscale è¿æ¥ä¸»èŠ‚ç‚¹çš„ Redis
- **Grafana Alloy**: DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œè‡ªåŠ¨æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹çš„æŒ‡æ ‡å’Œæ—¥å¿—

### ä»»åŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant ZSET as Redis ZSET
    participant SCH as è°ƒåº¦å™¨
    participant RQ as Redis é˜Ÿåˆ—
    participant CRW as çˆ¬è™« (ä»»æ„èŠ‚ç‚¹)
    participant SM as çŠ¶æ€æœº
    participant PIP as å¤„ç†ç®¡é“
    participant DB as MySQL

    SCH->>ZSET: æŸ¥è¯¢æœ€è¿‘è°ƒåº¦æ—¶é—´
    SCH->>SCH: ç²¾ç¡®ç¡çœ åˆ°è¯¥æ—¶é—´
    SCH->>ZSET: è·å–åˆ°æœŸçš„IP
    SCH->>RQ: æ¨é€çˆ¬å–ä»»åŠ¡

    loop çˆ¬è™«å¾ªç¯
        CRW->>RQ: æ‹‰å–ä»»åŠ¡ (BRPOP)
        CRW->>CRW: HTTP è®¤è¯è¯·æ±‚
        CRW->>CRW: çˆ¬å–åœ¨å”®é¡µé¢ x5
        CRW->>CRW: çˆ¬å–å·²å”®é¡µé¢ x5
        CRW->>RQ: æ¨é€ç»“æœ
    end

    PIP->>RQ: æ‹‰å–ç»“æœ
    PIP->>SM: æ‰¹é‡å¤„ç†å•†å“
    SM->>SM: æ£€æµ‹çŠ¶æ€å˜åŒ– (æ–°ä¸Šæ¶/å–å‡º/æ”¹ä»·)
    SM-->>PIP: è¿”å›å˜åŒ–è®°å½•
    PIP->>PIP: è®¡ç®—æŒ‡æ ‡ (æµå…¥/æµå‡º/æµåŠ¨æ€§)
    PIP->>DB: å†™å…¥å°æ—¶ç»Ÿè®¡
    PIP->>ZSET: é—­ç¯æ›´æ–°ä¸‹æ¬¡è°ƒåº¦æ—¶é—´
    PIP->>RQ: æ¸…é™¤ç›¸å…³ç¼“å­˜
```

## æŠ€æœ¯æ ˆ

- **åç«¯**: Go 1.24+ (Gin + GORM)
- **çˆ¬è™«**: Python 3.11+ (HTTP è®¤è¯ + Playwright é™çº§)
- **æ¶ˆæ¯æ ¼å¼**: Protocol Buffers (protojson)
- **æ•°æ®åº“**: MySQL 8.0 + Redis 7.x
- **ç›‘æ§**: Prometheus + Grafana Cloud + Alloy

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker & Docker Compose
- Go 1.24+

### æœ¬åœ°å¼€å‘

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/KahanaT800/animehot
cd animehot

# å¤åˆ¶ç¯å¢ƒé…ç½®
cp .env.example .env

# å¯åŠ¨åŸºç¡€è®¾æ–½ (MySQL + Redis)
make dev-deps

# å¯åŠ¨åˆ†æå™¨ (ç»ˆç«¯1)
make dev-analyzer

# å¯åŠ¨çˆ¬è™« (ç»ˆç«¯2)
make dev-crawler

# å¯¼å…¥æµ‹è¯•IP
make api-import-run FILE=data/ips.json
```

### Docker éƒ¨ç½²

```bash
# å…¨å®¶æ¡¶ (MySQL + Redis + Analyzer + Crawler)
make docker-up

# è½»é‡æ¨¡å¼ (ä¸å¸¦çˆ¬è™«ï¼Œçº¯æµ‹è¯•ç”¨)
make docker-light-up

# å¸¦ç›‘æ§ (Grafana Cloud)
make docker-up-monitoring

# æŸ¥çœ‹æ—¥å¿—
make docker-logs
```

## ç”Ÿäº§éƒ¨ç½²

### EC2 åˆå§‹åŒ–

```bash
# 1. å®‰è£… Docker
sudo yum update -y
sudo yum install -y docker git
sudo systemctl start docker && sudo systemctl enable docker
sudo usermod -aG docker ec2-user

# 2. å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
  -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 3. å®‰è£… Tailscale (ç”¨äºåˆ†å¸ƒå¼çˆ¬è™«)
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up

# 4. å…‹éš†å¹¶é…ç½®
git clone https://github.com/lyc0603/animetop.git
cd animetop
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥ç”Ÿäº§é…ç½®

# 5. åˆå§‹åŒ– SSL å¹¶å¯åŠ¨æœåŠ¡
export DOMAIN_NAME=your-domain.com
export LETSENCRYPT_EMAIL=admin@your-domain.com
./deploy/certbot/init-letsencrypt.sh
```

### å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] MySQL ç«¯å£ (3306) æ²¡æœ‰å¯¹å¤–æš´éœ²
- [ ] Redis åªèƒ½é€šè¿‡ Tailscale VPN è®¿é—®
- [ ] Admin API ç”¨ `ADMIN_API_KEY` ä¿æŠ¤
- [ ] å¼ºåˆ¶ HTTPS + HSTS
- [ ] `/metrics` ç«¯ç‚¹ç¦æ­¢å¤–éƒ¨è®¿é—®

## K8s/Spot åˆ†å¸ƒå¼çˆ¬è™«

ä½¿ç”¨ AWS Spot å®ä¾‹æŒ‰éœ€æ‰©å±•çˆ¬è™«å®¹é‡ï¼Œæˆæœ¬ä»…ä¸ºæŒ‰éœ€å®ä¾‹çš„ 10-30%ã€‚

### æ¶æ„è¯´æ˜

```
EC2 ä¸»èŠ‚ç‚¹ (K3s Server)          Spot èŠ‚ç‚¹æ±  (K3s Agent)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Analyzer           â”‚          â”‚  py-crawler Pod     â”‚
â”‚  MySQL / Redis      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  py-crawler Pod     â”‚
â”‚  KEDA               â”‚ Tailscaleâ”‚  Alloy DaemonSet    â”‚
â”‚  Spot ASG Scaler    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â–²
         â”‚                                 â”‚
         â–¼                                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     è°ƒæ•´å®¹é‡      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ é˜Ÿåˆ—æ·±åº¦  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  EC2 ASG      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è‡ªåŠ¨æ‰©ç¼©å®¹é€»è¾‘

| è§¦å‘æ¡ä»¶ | åŠ¨ä½œ |
|---------|------|
| é˜Ÿåˆ—æ·±åº¦ > 0 | KEDA åˆ›å»º py-crawler Pod |
| Pod pending (æ— èŠ‚ç‚¹) | Scaler å¯åŠ¨ Spot å®ä¾‹ |
| èŠ‚ç‚¹ç©ºé—² 15 åˆ†é’Ÿ | Scaler ç»ˆæ­¢ Spot å®ä¾‹ |
| Spot ä¸­æ–­é€šçŸ¥ | ä¼˜é›…å…³é—­ Podï¼ŒèŠ‚ç‚¹è‡ªåŠ¨æ¸…ç† |

### K3s é›†ç¾¤åˆå§‹åŒ–

```bash
# EC2 ä¸»èŠ‚ç‚¹ - å®‰è£… K3s Server
curl -sfL https://get.k3s.io | sh -s - server \
  --tls-san $(tailscale ip -4) \
  --node-external-ip $(tailscale ip -4)

# è·å– join token
cat /var/lib/rancher/k3s/server/node-token

# éƒ¨ç½² K8s èµ„æº
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/secrets.yaml  # éœ€è¦å…ˆå¡«å…¥å‡­æ®
kubectl apply -f k8s/py-crawler.yaml
kubectl apply -f k8s/keda-scaledobject.yaml
kubectl apply -f k8s/spot-asg-scaler.yaml
kubectl apply -f k8s/alloy-configmap.yaml
kubectl apply -f k8s/alloy-daemonset.yaml
```

### Spot èŠ‚ç‚¹é…ç½®

Spot å®ä¾‹å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ `infra/aws/user-data-spot.sh`:

1. å®‰è£… Tailscale å¹¶åŠ å…¥ç½‘ç»œ
2. åŠ å…¥ K3s é›†ç¾¤ä½œä¸º Agent èŠ‚ç‚¹
3. è®¾ç½® Tailscale æ¸…ç† hook (ç»ˆæ­¢æ—¶è‡ªåŠ¨æ³¨é”€)
4. ç›‘å¬ Spot ä¸­æ–­é€šçŸ¥

### å…³é”® K8s èµ„æº

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `k8s/py-crawler.yaml` | py-crawler Deployment |
| `k8s/keda-scaledobject.yaml` | KEDA è‡ªåŠ¨æ‰©ç¼©å®¹è§„åˆ™ |
| `k8s/spot-asg-scaler.yaml` | Spot èŠ‚ç‚¹ç®¡ç† CronJob |
| `k8s/alloy-*.yaml` | Grafana Alloy ç›‘æ§é…ç½® |
| `k8s/secrets.yaml.template` | å‡­æ®æ¨¡æ¿ |

## ç›‘æ§

### Grafana Cloud é…ç½®

1. æ³¨å†Œ [Grafana Cloud](https://grafana.com/products/cloud/) è´¦å·
2. è·å– Prometheus remote write å‡­æ®
3. è·å– Loki å‡­æ® (æ—¥å¿—ç”¨)
4. åœ¨ `.env` ä¸­é…ç½®:

```bash
GRAFANA_CLOUD_PROM_REMOTE_WRITE_URL=https://prometheus-xxx.grafana.net/api/prom/push
GRAFANA_CLOUD_PROM_USERNAME=your_username
GRAFANA_CLOUD_PROM_API_KEY=glc_xxx

GRAFANA_CLOUD_LOKI_URL=https://logs-xxx.grafana.net/loki/api/v1/push
GRAFANA_CLOUD_LOKI_USERNAME=your_username
GRAFANA_CLOUD_LOKI_API_KEY=glc_xxx
```

5. å¸¦ç›‘æ§é…ç½®å¯åŠ¨:

```bash
docker compose -f docker-compose.prod.yml --profile monitoring up -d
```

### å¯¼å…¥ä»ªè¡¨ç›˜

ä» `deploy/grafana/dashboards/animehot-business.json` å¯¼å…¥ä¸šåŠ¡ä»ªè¡¨ç›˜:

| åŒºåŸŸ | é¢æ¿ |
|------|------|
| Overview | æœåŠ¡çŠ¶æ€ã€æ´»è·ƒä»»åŠ¡ã€é˜Ÿåˆ—æ·±åº¦ |
| Spot Py-Crawler | çˆ¬è™«æ•°ã€ä»»åŠ¡è¿›åº¦ã€å»¶è¿Ÿã€Auth æ¨¡å¼ |
| Task Queue | ä»»åŠ¡ååé‡ã€é˜Ÿåˆ—çŠ¶æ€ |
| Redis Queues | DLQã€è°ƒåº¦ IPã€ä»»åŠ¡/ç»“æœé˜Ÿåˆ— |

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ |
|------|------|
| `up{job="animetop-analyzer"}` | Analyzer å¥åº·çŠ¶æ€ |
| `up{app="py-crawler", cluster="animehot-k3s"}` | Spot çˆ¬è™«å¥åº·çŠ¶æ€ |
| `mercari_crawler_tasks_in_progress{cluster="animehot-k3s"}` | Spot æ­£åœ¨å¤„ç†çš„ä»»åŠ¡æ•° |
| `mercari_crawler_api_request_duration_seconds` | API è¯·æ±‚å»¶è¿Ÿ |
| `mercari_crawler_auth_mode` | è®¤è¯æ¨¡å¼ (0=HTTP, 1=Browser) |
| `animetop_scheduler_tasks_pending_in_queue` | é˜Ÿåˆ—æ·±åº¦ |
| `animetop_queue_length{queue="schedule"}` | å·²è°ƒåº¦çš„ IP æ•°é‡ |

## API æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/health` | å¥åº·æ£€æŸ¥ |
| GET | `/api/v1/ips` | è·å–æ‰€æœ‰è¿½è¸ªçš„IPåˆ—è¡¨ |
| GET | `/api/v1/ips/:id` | è·å–IPè¯¦æƒ… |
| GET | `/api/v1/ips/:id/liquidity` | è·å–æµåŠ¨æ€§æ•°æ® |
| GET | `/api/v1/ips/:id/stats/hourly` | è·å–å°æ—¶ç»Ÿè®¡ |
| GET | `/api/v1/ips/:id/items` | è·å–å•†å“åˆ—è¡¨ |
| GET | `/api/v1/leaderboard` | è·å–æ’è¡Œæ¦œ |
| GET | `/api/v1/system/status` | ç³»ç»ŸçŠ¶æ€ |
| POST | `/api/v1/admin/import` | å¯¼å…¥IP (éœ€è¦APIå¯†é’¥) |

### æ’è¡Œæ¦œ API

```bash
# è·å–è¿‡å»24å°æ—¶çƒ­åº¦å‰10çš„IP
curl "http://localhost:8080/api/v1/leaderboard?type=hot&hours=24&limit=10"
```

å‚æ•°:
- `type`: `hot` | `inflow` | `outflow`
- `hours`: 1-168 (æ—¶é—´çª—å£)
- `limit`: 1-100

å“åº”ç¤ºä¾‹:
```json
{
  "code": 0,
  "data": {
    "type": "hot",
    "hours": 24,
    "time_range": {
      "start": "2026-01-17T17:00:00+09:00",
      "end": "2026-01-18T17:00:00+09:00"
    },
    "items": [
      {
        "rank": 1,
        "ip_id": 11,
        "ip_name": "é¬¼ç­ä¹‹åˆƒ",
        "inflow": 355,
        "outflow": 28,
        "score": 0.2634
      }
    ]
  }
}
```

### Admin API

```bash
# å¯¼å…¥IP (ç”Ÿäº§ç¯å¢ƒéœ€è¦ X-API-Key å¤´)
curl -X POST http://localhost:8080/api/v1/admin/import \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your_api_key" \
  -d @data/ips.json
```

## é…ç½®

### å…³é”®ç¯å¢ƒå˜é‡

```bash
# åŸŸå (SSLç”¨)
DOMAIN_NAME=anime-hot.com
LETSENCRYPT_EMAIL=admin@anime-hot.com

# å®‰å…¨
ADMIN_API_KEY=your_secure_api_key

# æ•°æ®åº“
MYSQL_PASSWORD=your_secure_password

# è°ƒåº¦å™¨ (ZSET æŒä¹…åŒ– + ç²¾ç¡®ç¡çœ )
SCHEDULER_BASE_INTERVAL=2h      # åŸºç¡€çˆ¬å–é—´éš”
SCHEDULER_MIN_INTERVAL=1h       # æœ€å°é—´éš” (çƒ­é—¨IP)
SCHEDULER_MAX_INTERVAL=2h       # æœ€å¤§é—´éš”

# çˆ¬è™«
BROWSER_MAX_CONCURRENCY=2       # åŒæ—¶å¼€çš„æµè§ˆå™¨æ ‡ç­¾é¡µæ•°
SCHEDULER_PAGES_ON_SALE=5       # æ¯æ¬¡çˆ¬å–åœ¨å”®é¡µæ•°
SCHEDULER_PAGES_SOLD=5          # æ¯æ¬¡çˆ¬å–å·²å”®é¡µæ•°
```

### åŠ¨æ€é—´éš”è°ƒæ•´

è°ƒåº¦å™¨ä¼šæ ¹æ®æ´»è·ƒåº¦è‡ªåŠ¨è°ƒæ•´çˆ¬å–é¢‘ç‡ (é—­ç¯æ›´æ–°åˆ° Redis ZSET):

| æ¡ä»¶ | åŠ¨ä½œ |
|------|------|
| æµå…¥ > 100Ã—é¡µæ•° æˆ– æµå‡º > 100Ã—é¡µæ•° | åŠ é€Ÿ (-15åˆ†é’Ÿ) |
| æµå…¥ < 50Ã—é¡µæ•° ä¸” æµå‡º < 3Ã—é¡µæ•° | å‡é€Ÿ (+15åˆ†é’Ÿ) |
| å…¶ä»–æƒ…å†µ | å‘2å°æ—¶å›å½’ |

é»˜è®¤ 5+5 é¡µé…ç½®ä¸‹:
- **åŠ é€Ÿæ¡ä»¶**: æµå…¥ > 500 æˆ– æµå‡º > 500
- **å‡é€Ÿæ¡ä»¶**: æµå…¥ < 250 ä¸” æµå‡º < 15

## Make å‘½ä»¤

```bash
# æ„å»º
make build              # æ„å»ºæ‰€æœ‰ Go äºŒè¿›åˆ¶
make test               # è·‘æµ‹è¯•
make lint               # è·‘ linter

# Docker - å…¨å®¶æ¡¶
make docker-up          # å¯åŠ¨æ‰€æœ‰æœåŠ¡
make docker-down        # åœæ­¢æ‰€æœ‰æœåŠ¡
make docker-logs        # æŸ¥çœ‹æ—¥å¿—

# Docker - è½»é‡ç‰ˆ (ä¸å¸¦çˆ¬è™«)
make docker-light-up    # å¯åŠ¨ MySQL + Redis + Analyzer
make docker-light-down  # åœæ­¢è½»é‡æœåŠ¡

# Docker - å¸¦ç›‘æ§
make docker-up-monitoring    # å¯åŠ¨å…¨éƒ¨ + Grafana Alloy
make docker-down-monitoring  # åœæ­¢å…¨éƒ¨ + ç›‘æ§

# å¼€å‘
make dev-deps           # åªå¯åŠ¨ MySQL & Redis
make dev-analyzer       # æœ¬åœ°è·‘ Analyzer
make dev-crawler        # æœ¬åœ°è·‘ Crawler

# æ•°æ®å¯¼å…¥
make api-import-run FILE=data/ips.json

# ç°åº¦æµ‹è¯•
make grayscale-start    # å…¨å®¶æ¡¶ + æµ‹è¯•IP
make grayscale-verify   # éªŒè¯æ•°æ®æµ
make grayscale-clean    # æ¸…ç†
```

## é¡¹ç›®ç»“æ„

```
animetop/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ analyzer/          # API + è°ƒåº¦å™¨ + å¤„ç†ç®¡é“
â”‚   â”œâ”€â”€ crawler/           # Go çˆ¬è™« (deprecated)
â”‚   â””â”€â”€ import/            # IPæ•°æ®å¯¼å…¥å·¥å…·
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ analyzer/          # æ ¸å¿ƒåˆ†æé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ pipeline.go    # ç»“æœå¤„ç†
â”‚   â”‚   â”œâ”€â”€ state_machine.go  # å•†å“çŠ¶æ€è¿½è¸ª
â”‚   â”‚   â””â”€â”€ cache.go       # ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ api/               # HTTP æ¥å£
â”‚   â”œâ”€â”€ config/            # é…ç½®
â”‚   â”œâ”€â”€ model/             # æ•°æ®åº“æ¨¡å‹ (GORM)
â”‚   â”œâ”€â”€ pkg/               # å…¬å…±å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ metrics/       # Prometheus æŒ‡æ ‡
â”‚   â”‚   â”œâ”€â”€ ratelimit/     # é™æµ
â”‚   â”‚   â””â”€â”€ redisqueue/    # å¯é é˜Ÿåˆ—
â”‚   â””â”€â”€ scheduler/         # IP è°ƒåº¦ (ZSET æŒä¹…åŒ–)
â”œâ”€â”€ py-crawler/            # Python çˆ¬è™« (ç§æœ‰å­æ¨¡å—)
â”œâ”€â”€ k8s/                   # Kubernetes èµ„æº
â”‚   â”œâ”€â”€ py-crawler.yaml    # çˆ¬è™« Deployment
â”‚   â”œâ”€â”€ keda-scaledobject.yaml  # KEDA è‡ªåŠ¨æ‰©ç¼©å®¹
â”‚   â”œâ”€â”€ spot-asg-scaler.yaml    # Spot èŠ‚ç‚¹ç®¡ç†
â”‚   â”œâ”€â”€ alloy-*.yaml       # Grafana Alloy ç›‘æ§
â”‚   â””â”€â”€ secrets.yaml.template   # å‡­æ®æ¨¡æ¿
â”œâ”€â”€ infra/aws/             # AWS åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ asg.yaml           # Auto Scaling Group é…ç½®
â”‚   â”œâ”€â”€ launch-template.json    # EC2 Launch Template
â”‚   â”œâ”€â”€ user-data-spot.sh  # Spot å®ä¾‹åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ iam-policy.json    # IAM ç­–ç•¥
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ nginx/             # Nginx é…ç½®
â”‚   â”œâ”€â”€ certbot/           # SSL åˆå§‹åŒ–
â”‚   â””â”€â”€ grafana/           # ä»ªè¡¨ç›˜ JSON
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ k3s-init.sh        # K3s é›†ç¾¤åˆå§‹åŒ–
â”œâ”€â”€ proto/                 # Protocol Buffers
â”œâ”€â”€ migrations/            # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ data/                  # æµ‹è¯•æ•°æ® (IP JSON)
â”œâ”€â”€ docker-compose.yml           # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ docker-compose.prod.yml      # ç”Ÿäº§ç¯å¢ƒ (EC2)
â””â”€â”€ docker-compose.crawler.yml   # æœ¬åœ°çˆ¬è™«èŠ‚ç‚¹ (å¤‡ç”¨)
```

## æ•°æ®åº“è®¾è®¡

### ip_metadata
å­˜å‚¨ IPï¼ˆçŸ¥è¯†äº§æƒ/åŠ¨æ¼«ä½œå“ï¼‰ä¿¡æ¯

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”® |
| name | VARCHAR | æ—¥æ–‡å |
| name_en | VARCHAR | è‹±æ–‡å |
| category | VARCHAR | åˆ†ç±» (anime, game ç­‰) |
| weight | FLOAT | è°ƒåº¦ä¼˜å…ˆçº§ |

### ip_stats_hourly
æ¯ä¸ªIPçš„å°æ—¶ç»Ÿè®¡

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| ip_id | INT | å¤–é”®å…³è” ip_metadata |
| hour_bucket | DATETIME | å°æ—¶æ—¶é—´æˆ³ |
| inflow | INT | æ–°ä¸Šæ¶æ•° |
| outflow | INT | æˆäº¤æ•° |
| liquidity_index | FLOAT | æµå‡º / æµå…¥ |

### item_snapshots
å•ä¸ªå•†å“è¿½è¸ª

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| source_id | VARCHAR | ç…¤ç‚‰å•†å“ID |
| ip_id | INT | å…³è”çš„IP |
| status | ENUM | on_sale, sold |
| price | INT | ä»·æ ¼ (æ—¥å…ƒ) |
| first_seen | DATETIME | é¦–æ¬¡æŠ“å–æ—¶é—´ |
| last_seen | DATETIME | æœ€åæŠ“å–æ—¶é—´ |

## å¸¸è§é—®é¢˜æ’æŸ¥

### çˆ¬è™«ä¸å¤„ç†ä»»åŠ¡

```bash
# æ£€æŸ¥é˜Ÿåˆ—æ·±åº¦
redis-cli LLEN animetop:queue:tasks

# æ£€æŸ¥ Spot çˆ¬è™« Pod çŠ¶æ€
kubectl get pods -n animehot -l app=py-crawler

# æ£€æŸ¥çˆ¬è™«æ—¥å¿—
kubectl logs -n animehot -l app=py-crawler --tail 100

# æ£€æŸ¥ KEDA ScaledObject çŠ¶æ€
kubectl get scaledobject -n animehot
```

### Spot èŠ‚ç‚¹æ²¡æœ‰å¯åŠ¨

```bash
# æ£€æŸ¥ Scaler æ—¥å¿—
kubectl logs -n kube-system -l app=spot-asg-scaler --tail 50

# æ£€æŸ¥ ASG çŠ¶æ€
aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names animehot-spot-asg

# æ‰‹åŠ¨è§¦å‘æ‰©å®¹ (æµ‹è¯•ç”¨)
aws autoscaling set-desired-capacity \
  --auto-scaling-group-name animehot-spot-asg \
  --desired-capacity 1
```

### Grafana çœ‹ä¸åˆ° Spot æŒ‡æ ‡

```bash
# æ£€æŸ¥ Alloy Pod çŠ¶æ€
kubectl get pods -n animehot -l app=alloy

# æ£€æŸ¥ Alloy æ—¥å¿—
kubectl logs -n animehot daemonset/alloy --tail 50

# éªŒè¯ up æŒ‡æ ‡
# åœ¨ Grafana: up{app="py-crawler", cluster="animehot-k3s"}
```

### Spot èŠ‚ç‚¹åŠ å…¥å¤±è´¥

```bash
# SSH åˆ° Spot å®ä¾‹æ£€æŸ¥æ—¥å¿—
journalctl -u k3s-agent -f

# æ£€æŸ¥ Tailscale çŠ¶æ€
tailscale status

# æ£€æŸ¥ K3s Server è¿æ¥
curl -k https://100.99.127.100:6443/healthz
```

## å¼€æºåè®®

MIT

## è‡´è°¢

- [ç…¤ç‚‰](https://jp.mercari.com/) - æ•°æ®æ¥æº
- [Playwright](https://playwright.dev/) - æµè§ˆå™¨è‡ªåŠ¨åŒ–
- [Gin](https://github.com/gin-gonic/gin) - Web æ¡†æ¶
- [K3s](https://k3s.io/) - è½»é‡ Kubernetes
- [KEDA](https://keda.sh/) - è‡ªåŠ¨æ‰©ç¼©å®¹
- [Grafana](https://grafana.com/) - ç›‘æ§
- [Tailscale](https://tailscale.com/) - åˆ†å¸ƒå¼ VPN
