# .github/workflows/deploy.yml
# Anime Hot - CD Pipeline
#
# 流程: GitHub Actions 构建镜像 → 推送 GHCR → EC2 拉取部署

name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  ANALYZER_IMAGE: ghcr.io/kahanat800/animehot/analyzer
  CRAWLER_IMAGE: ghcr.io/kahanat800/animehot/crawler

jobs:
  ci:
    name: CI Check
    uses: ./.github/workflows/ci.yml

  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [ci]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Analyzer
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile.analyzer
          push: true
          tags: |
            ${{ env.ANALYZER_IMAGE }}:latest
            ${{ env.ANALYZER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Crawler
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile.crawler
          push: true
          tags: |
            ${{ env.CRAWLER_IMAGE }}:latest
            ${{ env.CRAWLER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [build-and-push]

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          ANALYZER_IMAGE: ${{ env.ANALYZER_IMAGE }}:${{ github.sha }}
          CRAWLER_IMAGE: ${{ env.CRAWLER_IMAGE }}:${{ github.sha }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ANALYZER_IMAGE,CRAWLER_IMAGE,GHCR_TOKEN,GHCR_USER
          script_stop: true
          script: |
            set -e

            echo "=========================================="
            echo "开始部署 Anime Hot"
            echo "ANALYZER: $ANALYZER_IMAGE"
            echo "CRAWLER: $CRAWLER_IMAGE"
            echo "=========================================="

            cd ~/animehot

            # 1. 拉取最新代码 (获取 compose 文件更新)
            echo "[1/5] 拉取最新代码..."
            git fetch origin main
            git reset --hard origin/main

            # 2. 登录 GHCR
            echo "[2/5] 登录 GHCR..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u $GHCR_USER --password-stdin

            # 3. 拉取新镜像
            echo "[3/5] 拉取镜像..."
            docker pull $ANALYZER_IMAGE
            docker pull $CRAWLER_IMAGE

            # 4. 更新并重启服务
            echo "[4/5] 重启服务..."
            export ANALYZER_IMAGE=$ANALYZER_IMAGE
            export CRAWLER_IMAGE=$CRAWLER_IMAGE

            # 先停止 nginx（避免 DNS 缓存问题）
            docker compose -f docker-compose.prod.yml stop nginx || true

            # 启动新的 analyzer 和 crawler
            docker compose -f docker-compose.prod.yml up -d analyzer crawler

            # 等待 analyzer 健康
            sleep 10

            # 重启 nginx（刷新 upstream DNS）
            docker compose -f docker-compose.prod.yml up -d nginx

            # 5. 验证
            echo "[5/5] 验证服务状态..."
            sleep 15

            if docker exec animehot-analyzer wget -qO- http://127.0.0.1:8080/health 2>/dev/null | grep -q '"status":"ok"'; then
              echo "✅ Analyzer 健康检查通过"
            else
              echo "❌ Analyzer 健康检查失败"
              docker compose -f docker-compose.prod.yml logs --tail=50 analyzer
              exit 1
            fi

            # 清理垃圾
            echo "清理旧资源..."
            docker container prune -f || true
            docker image prune -af || true
            docker builder prune -af || true
            docker volume prune -f || true

            echo ""
            echo "=========================================="
            echo "部署完成！"
            echo "=========================================="
            docker compose -f docker-compose.prod.yml ps

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::部署失败，请检查 EC2 日志"
