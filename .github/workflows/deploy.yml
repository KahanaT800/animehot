# .github/workflows/deploy.yml
# Anime Hot - CD Pipeline
#
# è§¦å‘æ¡ä»¶: CI workflow æˆåŠŸå®ŒæˆåŽè‡ªåŠ¨è§¦å‘
# æµç¨‹:
#   - Analyzer: GitHub Actions æž„å»ºé•œåƒ â†’ GHCR â†’ EC2 docker-compose éƒ¨ç½²
#   - py-crawler: GitHub Actions æž„å»ºé•œåƒ â†’ GHCR â†’ K8s æ»šåŠ¨æ›´æ–°
#
# æ··åˆéƒ¨ç½²æ¨¡å¼ (è¿‡æ¸¡é˜¶æ®µ):
#   - ä¸» EC2: Analyzer + Redis (docker-compose) + K3s Server
#   - Spot èŠ‚ç‚¹: py-crawler (K8s + KEDA)

name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/kahanat800/animehot

jobs:
  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [analyzer, py-crawler]
    outputs:
      image_tag: ${{ github.event.workflow_run.head_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile.${{ matrix.service }}
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest
            ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.event.workflow_run.head_sha }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  # ============================================================================
  # Deploy Analyzer to EC2 (docker-compose)
  # ============================================================================
  deploy-analyzer:
    name: Deploy Analyzer (EC2)
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Deploy Analyzer to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          ANALYZER_IMAGE: ${{ env.IMAGE_PREFIX }}/analyzer:${{ github.event.workflow_run.head_sha }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ANALYZER_IMAGE,GHCR_TOKEN,GHCR_USER
          script_stop: true
          script: |
            set -e

            echo "=========================================="
            echo "éƒ¨ç½² Analyzer (docker-compose)"
            echo "ANALYZER: $ANALYZER_IMAGE"
            echo "=========================================="

            cd ~/animehot

            # 1. æ‹‰å–æœ€æ–°ä»£ç  (ä¸æ‹‰å–å­æ¨¡å—ï¼Œéƒ¨ç½²åªéœ€è¦ compose é…ç½®)
            echo "[1/4] æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin main
            git reset --hard origin/main
            # æ³¨æ„ï¼šä¸æ‰§è¡Œ submodule updateï¼Œå› ä¸ºéƒ¨ç½²åªéœ€è¦ Docker é•œåƒï¼Œä¸éœ€è¦æºç 

            # 2. ç™»å½• GHCR
            echo "[2/4] ç™»å½• GHCR..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u $GHCR_USER --password-stdin

            # 3. æ‹‰å–å¹¶é‡å¯ Analyzer
            echo "[3/4] é‡å¯ Analyzer..."
            docker pull $ANALYZER_IMAGE
            export ANALYZER_IMAGE=$ANALYZER_IMAGE

            # åœæ­¢ nginxï¼ˆé¿å… DNS ç¼“å­˜é—®é¢˜ï¼‰
            docker compose -f docker-compose.prod.yml stop nginx || true

            # åªé‡å¯ analyzerï¼ˆä¸å†å¯åŠ¨ py-crawlerï¼‰
            docker compose -f docker-compose.prod.yml up -d analyzer

            # 4. å¥åº·æ£€æŸ¥
            echo "[4/4] ç­‰å¾… Analyzer å¥åº·..."
            for i in $(seq 1 12); do
              if docker exec animehot-analyzer wget -qO- http://127.0.0.1:8080/health 2>/dev/null | grep -q '"status":"ok"'; then
                echo "âœ… Analyzer å¥åº·æ£€æŸ¥é€šè¿‡ (${i}æ¬¡å°è¯•)"
                break
              fi
              if [ $i -eq 12 ]; then
                echo "âŒ Analyzer å¥åº·æ£€æŸ¥å¤±è´¥"
                docker compose -f docker-compose.prod.yml logs --tail=50 analyzer
                exit 1
              fi
              echo "ç­‰å¾…ä¸­... ($i/12)"
              sleep 5
            done

            # é‡å¯ nginx
            docker compose -f docker-compose.prod.yml up -d nginx

            # æ¸…ç†æ—§é•œåƒ
            echo "æ¸…ç†æ—§èµ„æº..."
            docker image prune -af || true

            echo ""
            echo "=========================================="
            echo "Analyzer éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="

  # ============================================================================
  # Deploy py-crawler to K8s (æ»šåŠ¨æ›´æ–°)
  # ============================================================================
  deploy-py-crawler:
    name: Deploy py-crawler (K8s)
    runs-on: ubuntu-latest
    needs: [build]
    # åªæœ‰å½“ K3S_ENABLED secret å­˜åœ¨æ—¶æ‰è¿è¡Œ
    if: ${{ vars.K3S_ENABLED == 'true' }}
    steps:
      - name: Update K8s Deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          PY_CRAWLER_IMAGE: ${{ env.IMAGE_PREFIX }}/py-crawler:${{ github.event.workflow_run.head_sha }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: PY_CRAWLER_IMAGE
          script_stop: true
          script: |
            set -e

            echo "=========================================="
            echo "æ›´æ–° K8s py-crawler é•œåƒ"
            echo "IMAGE: $PY_CRAWLER_IMAGE"
            echo "=========================================="

            # K3s kubectl éœ€è¦ sudo
            KUBECTL="sudo kubectl"

            # æ£€æŸ¥ kubectl æ˜¯å¦å¯ç”¨
            if ! command -v kubectl &> /dev/null; then
              echo "âŒ kubectl æœªå®‰è£…ï¼Œè·³è¿‡ K8s éƒ¨ç½²"
              exit 0
            fi

            # æ£€æŸ¥ K3s æ˜¯å¦è¿è¡Œ
            if ! $KUBECTL cluster-info &> /dev/null; then
              echo "âŒ K3s é›†ç¾¤ä¸å¯ç”¨ï¼Œè·³è¿‡ K8s éƒ¨ç½²"
              exit 0
            fi

            # æ›´æ–°é•œåƒ
            echo "æ›´æ–° Deployment é•œåƒ..."
            $KUBECTL set image deployment/py-crawler \
              py-crawler=$PY_CRAWLER_IMAGE \
              -n animehot

            # æ£€æŸ¥å½“å‰å‰¯æœ¬æ•° (KEDA å¯èƒ½å°†å…¶ç¼©å®¹åˆ° 0)
            REPLICAS=$($KUBECTL get deployment py-crawler -n animehot -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0")
            echo "å½“å‰å‰¯æœ¬æ•°: $REPLICAS"

            if [ "$REPLICAS" -eq 0 ]; then
              echo "â„¹ï¸ Deployment replicas=0 (KEDA å·²ç¼©å®¹), è·³è¿‡ rollout ç­‰å¾…"
              echo "   ä¸‹æ¬¡ KEDA æ‰©å®¹æ—¶å°†è‡ªåŠ¨ä½¿ç”¨æ–°é•œåƒ"
            else
              # ç­‰å¾…æ»šåŠ¨æ›´æ–°å®Œæˆ
              echo "ç­‰å¾…æ»šåŠ¨æ›´æ–°..."
              $KUBECTL rollout status deployment/py-crawler \
                -n animehot \
                --timeout=300s || {
                  echo "âš ï¸ æ»šåŠ¨æ›´æ–°è¶…æ—¶ï¼Œæ£€æŸ¥ Pod çŠ¶æ€..."
                  $KUBECTL get pods -n animehot -l app=py-crawler
                  $KUBECTL describe deployment py-crawler -n animehot | tail -20
                }
            fi

            # æ˜¾ç¤ºå½“å‰çŠ¶æ€
            echo ""
            echo "=========================================="
            echo "K8s py-crawler éƒ¨ç½²çŠ¶æ€"
            echo "=========================================="
            $KUBECTL get pods -n animehot -l app=py-crawler

  # ============================================================================
  # Fallback: Deploy py-crawler to EC2 (docker-compose)
  # å½“ K3S_ENABLED != true æ—¶ä½¿ç”¨æ­¤æ–¹å¼
  # ============================================================================
  deploy-py-crawler-compose:
    name: Deploy py-crawler (docker-compose)
    runs-on: ubuntu-latest
    needs: [build]
    # åªæœ‰å½“ K3S_ENABLED ä¸ä¸º true æ—¶æ‰è¿è¡Œ
    if: ${{ vars.K3S_ENABLED != 'true' }}
    steps:
      - name: Deploy py-crawler to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          PY_CRAWLER_IMAGE: ${{ env.IMAGE_PREFIX }}/py-crawler:${{ github.event.workflow_run.head_sha }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: PY_CRAWLER_IMAGE,GHCR_TOKEN,GHCR_USER
          script_stop: true
          script: |
            set -e

            echo "=========================================="
            echo "éƒ¨ç½² py-crawler (docker-compose æ¨¡å¼)"
            echo "IMAGE: $PY_CRAWLER_IMAGE"
            echo "=========================================="

            cd ~/animehot

            # ç™»å½• GHCR
            echo "$GHCR_TOKEN" | docker login ghcr.io -u $GHCR_USER --password-stdin

            # æ‹‰å–å¹¶é‡å¯ py-crawler
            docker pull $PY_CRAWLER_IMAGE
            export PY_CRAWLER_IMAGE=$PY_CRAWLER_IMAGE
            docker compose -f docker-compose.prod.yml up -d py-crawler

            # å¥åº·æ£€æŸ¥
            echo "ç­‰å¾… py-crawler å¥åº·..."
            for i in $(seq 1 12); do
              if docker exec animehot-py-crawler curl -sf http://localhost:8081/health 2>/dev/null | grep -q '"healthy"'; then
                echo "âœ… py-crawler å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              if [ $i -eq 12 ]; then
                echo "âš ï¸ py-crawler å¥åº·æ£€æŸ¥è¶…æ—¶"
                docker compose -f docker-compose.prod.yml logs --tail=20 py-crawler
              fi
              sleep 5
            done

            echo "=========================================="
            echo "py-crawler (docker-compose) éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-analyzer, deploy-py-crawler, deploy-py-crawler-compose]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | éƒ¨ç½²æ–¹å¼ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Analyzer | docker-compose | ${{ needs.deploy-analyzer.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ vars.K3S_ENABLED }}" = "true" ]; then
            echo "| py-crawler | K8s | ${{ needs.deploy-py-crawler.result == 'success' && 'âœ…' || (needs.deploy-py-crawler.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| py-crawler | docker-compose | ${{ needs.deploy-py-crawler-compose.result == 'success' && 'âœ…' || (needs.deploy-py-crawler-compose.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| K3S æ¨¡å¼ | ${{ vars.K3S_ENABLED == 'true' && 'âœ… å¯ç”¨' || 'âŒ æœªå¯ç”¨' }} |" >> $GITHUB_STEP_SUMMARY
