# .github/workflows/deploy.yml
# Anime Hot - CD Pipeline
#
# è§¦å‘æ¡ä»¶: CI workflow æˆåŠŸå®ŒæˆåŽè‡ªåŠ¨è§¦å‘
# æµç¨‹: GitHub Actions æž„å»ºé•œåƒ (å¹¶è¡Œ) â†’ æŽ¨é€ GHCR â†’ EC2 æ‹‰å–éƒ¨ç½²

name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/kahanat800/animehot

jobs:
  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [analyzer, py-crawler]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile.${{ matrix.service }}
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest
            ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.event.workflow_run.head_sha }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          ANALYZER_IMAGE: ${{ env.IMAGE_PREFIX }}/analyzer:${{ github.event.workflow_run.head_sha }}
          PY_CRAWLER_IMAGE: ${{ env.IMAGE_PREFIX }}/py-crawler:${{ github.event.workflow_run.head_sha }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ANALYZER_IMAGE,PY_CRAWLER_IMAGE,GHCR_TOKEN,GHCR_USER
          script_stop: true
          script: |
            set -e

            echo "=========================================="
            echo "å¼€å§‹éƒ¨ç½² Anime Hot"
            echo "ANALYZER: $ANALYZER_IMAGE"
            echo "PY_CRAWLER: $PY_CRAWLER_IMAGE"
            echo "=========================================="

            cd ~/animehot

            # 1. æ‹‰å–æœ€æ–°ä»£ç  (èŽ·å– compose æ–‡ä»¶æ›´æ–°)
            echo "[1/5] æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin main
            git reset --hard origin/main

            # 2. ç™»å½• GHCR
            echo "[2/5] ç™»å½• GHCR..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u $GHCR_USER --password-stdin

            # 3. æ‹‰å–æ–°é•œåƒ
            echo "[3/5] æ‹‰å–é•œåƒ..."
            docker pull $ANALYZER_IMAGE
            docker pull $PY_CRAWLER_IMAGE

            # 4. æ›´æ–°å¹¶é‡å¯æœåŠ¡
            echo "[4/5] é‡å¯æœåŠ¡..."
            export ANALYZER_IMAGE=$ANALYZER_IMAGE
            export PY_CRAWLER_IMAGE=$PY_CRAWLER_IMAGE

            # å…ˆåœæ­¢ nginxï¼ˆé¿å… DNS ç¼“å­˜é—®é¢˜ï¼‰
            docker compose -f docker-compose.prod.yml stop nginx || true

            # åœæ­¢æ—§çš„ Go crawler (å¦‚æžœè¿˜åœ¨è¿è¡Œ)
            docker compose -f docker-compose.prod.yml stop crawler || true

            # å¯åŠ¨ analyzer å’Œ py-crawler
            docker compose -f docker-compose.prod.yml up -d analyzer py-crawler

            # 5. å¥åº·æ£€æŸ¥ (è½®è¯¢ï¼Œæœ€å¤šç­‰å¾… 60 ç§’)
            echo "[5/5] ç­‰å¾…æœåŠ¡å¥åº·..."
            for i in $(seq 1 12); do
              if docker exec animehot-analyzer wget -qO- http://127.0.0.1:8080/health 2>/dev/null | grep -q '"status":"ok"'; then
                echo "âœ… Analyzer å¥åº·æ£€æŸ¥é€šè¿‡ (${i}æ¬¡å°è¯•)"
                break
              fi
              if [ $i -eq 12 ]; then
                echo "âŒ Analyzer å¥åº·æ£€æŸ¥å¤±è´¥"
                docker compose -f docker-compose.prod.yml logs --tail=50 analyzer
                exit 1
              fi
              echo "ç­‰å¾…ä¸­... ($i/12)"
              sleep 5
            done

            # py-crawler å¥åº·æ£€æŸ¥
            for i in $(seq 1 12); do
              if docker exec animehot-py-crawler curl -sf http://localhost:8081/health 2>/dev/null | grep -q '"healthy"'; then
                echo "âœ… Python Crawler å¥åº·æ£€æŸ¥é€šè¿‡ (${i}æ¬¡å°è¯•)"
                break
              fi
              if [ $i -eq 12 ]; then
                echo "âš ï¸ Python Crawler å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œç»§ç»­éƒ¨ç½²..."
                docker compose -f docker-compose.prod.yml logs --tail=20 py-crawler
              fi
              echo "ç­‰å¾… py-crawler... ($i/12)"
              sleep 5
            done

            # é‡å¯ nginxï¼ˆåˆ·æ–° upstream DNSï¼‰
            docker compose -f docker-compose.prod.yml up -d nginx

            # æ¸…ç†åžƒåœ¾
            echo "æ¸…ç†æ—§èµ„æº..."
            docker container prune -f || true
            docker image prune -af || true
            docker builder prune -af || true
            docker volume prune -f || true

            echo ""
            echo "=========================================="
            echo "éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
            docker compose -f docker-compose.prod.yml ps

      - name: Deployment Summary
        if: success()
        run: |
          echo "## ðŸš€ éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Analyzer | \`${{ env.IMAGE_PREFIX }}/analyzer:${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Crawler | \`${{ env.IMAGE_PREFIX }}/py-crawler:${{ github.event.workflow_run.head_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘è€… | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥ EC2 æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "::error::éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ EC2 æ—¥å¿—"
